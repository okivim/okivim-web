# LSP / DAP / formatters

import '@site/src/css/icons.css';
import BashIcon from '@site/static/img/icons/bash-plain.svg';
import DockerIcon from '@site/static/img/icons/docker-plain.svg';
import CIcon from '@site/static/img/icons/c-original.svg';
import CPlusPlusIcon from '@site/static/img/icons/cplusplus-plain.svg';
import EslintIcon from '@site/static/img/icons/eslint-plain.svg';
import JsonIcon from '@site/static/img/icons/json-plain.svg';
import LuaIcon from '@site/static/img/icons/lua-plain.svg';
import PhpIcon from '@site/static/img/icons/php-plain.svg';
import PythonIcon from '@site/static/img/icons/python-plain.svg';
import RustIcon from '@site/static/img/icons/rust-original.svg';
import TailwindIcon from '@site/static/img/icons/tailwindcss-original.svg';
import CssIcon from '@site/static/img/icons/css3-plain.svg';
import JavascriptIcon from '@site/static/img/icons/javascript-plain.svg';
import TypescriptIcon from '@site/static/img/icons/typescript-plain.svg';
import AngularIcon from '@site/static/img/icons/angular-plain.svg';
import VueIcon from '@site/static/img/icons/vuejs-original.svg';
import ReactIcon from '@site/static/img/icons/react-original.svg';
import SvelteIcon from '@site/static/img/icons/svelte-plain.svg';
import AstroIcon from '@site/static/img/icons/astro-plain.svg';
import YamlIcon from '@site/static/img/icons/yaml-plain.svg';

## LSP servers

<p className="icons-wrapper">
<BashIcon className="icon" title="Bash" />
<DockerIcon className="icon" title="Docker" />
<CIcon className="icon" title="C" />
<CPlusPlusIcon className="icon" title="C++" />
<EslintIcon className="icon" title="Eslint" />
<JsonIcon className="icon" title="Json" />
<LuaIcon className="icon" title="Lua" />
<PhpIcon className="icon" title="Php" />
<PythonIcon className="icon" title="Python" />
<RustIcon className="icon" title="Rust" />
<TailwindIcon className="icon" title="Tailwind" />
<CssIcon className="icon" title="CSS" />
<JavascriptIcon className="icon" title="Javascript" />
<TypescriptIcon className="icon" title="Typescript" />
<AngularIcon className="icon" title="Angular" />
<VueIcon className="icon" title="Vue.js" />
<ReactIcon className="icon" title="React" />
<SvelteIcon className="icon" title="Svelte" />
<AstroIcon className="icon" title="Astro" />
<YamlIcon className="icon" title="Yaml" />
</p>

These LSPs, formatters, linters, and debug adapters are automatically installed and enabled. All of them are managed by Mason.

There are two ways to add a new LSP:

**1. Install it manually using Mason**  
This is useful for quick testing, but the change will **not be persistent** if you move the configuration to another machine.

**2. Register it in the configuration (recommended)**  
Create a Lua file with the name of the server inside:

E.g. `lua/okivim/lsp/servers/clangd.lua`

and add the configuration as described in the official documentation.  

```lua
return function(capabilities)
  vim.lsp.config("clangd", {
    capabilities = capabilities,
    cmd = {
      "clangd",
      "--background-index",
      "--clang-tidy",
      "--completion-style=detailed",
      "--header-insertion=iwyu",
    },
  })
end
```

:::info
The configuration is designed so that LSPs are automatically detected and added to the auto-install list based on the server file name; therefore, the file name must match the LSP server name.
:::

A full list of available LSP servers can be found here:  
https://github.com/neovim/nvim-lspconfig/blob/master/doc/configs.md

By doing this, the LSP will be registered in the list of servers that are automatically installed and configured, making the setup fully reproducible across machines.

## Debug adapters (DAP)

- debugpy (Python)
- codelldb (Rust / C / C++)
- js-debug-adapter (JS / TS)
- php-debug-adapter (PHP)

:::info
The Debug Adapter Protocol (DAP) configurations are defined in `lua/okivim/plugins/dap.lua`
:::

## Formatters

Okivim uses **Conform** for formatting.

### Philosophy

Okivim does **not** automatically install formatters for you.

Instead:

-   Install the formatter you want (via Mason if available, or
    manually).
-   If the formatter is already listed in `formatters_by_ft`, it will
    start working automatically.
-   If it is not listed, simply add it to the `formatters_by_ft` table
    in `conform.lua`.

This keeps the system simple, predictable, and easy to extend.

------------------------------------------------------------------------

### Default Included Formatters

The formatters defined by default in `conform.lua` are only related to
the LSP servers that are supported by default in this distribution.

They are included for convenience and consistency with the supported
languages, but they are **not automatically installed**.

You are still responsible for installing the formatter binary yourself.

------------------------------------------------------------------------

### How It Works

Each language has one or more formatters defined in:

``` lua
formatters_by_ft = {
  javascript = { "prettierd", "prettier" },
  python = { "black" },
  php = { "pint" },
  -- etc.
}
```

If the formatter binary exists in your system, Conform will use it.

If it does not exist, Conform will fall back to LSP formatting (because
`lsp_fallback = true` is enabled).

This means:

-   Nothing crashes.
-   Formatting still works if the LSP supports it.
-   You can decide which formatter to use by installing it.

------------------------------------------------------------------------

### Installing a Formatter

You can install formatters in two ways:

#### 1. Using Mason (if available)

`:Mason`

Search for the formatter and install it.

#### 2. Installing Manually

Some formatters belong to the language ecosystem and should be installed
manually.

Examples:

##### Python

`pipx install black`

##### Rust

`rustup component add rustfmt`

##### Node-based tools (Prettier, Prettierd, Stylelint)

Make sure you have:

- `node`
- `npm`

Then install globally or via Mason.

------------------------------------------------------------------------

### How to Verify Which Formatter Is Being Used

To check the active formatter for the current buffer:

`:ConformInfo`

⚠️ Do not rely on `:LspInfo` to verify external formatters.\
`:LspInfo` only shows LSP servers.

If formatting works but does not respect your configuration
(e.g. `.prettierrc`), you are likely seeing LSP fallback instead of the
external formatter.

------------------------------------------------------------------------

### Adding a New Formatter

To add a formatter for a new language:

``` lua
formatters_by_ft = {
  ...
  java = { "google-java-format" },
}
```

Make sure:

- The filetype matches Neovim's filetype name.
- The formatter binary exists in your system.

To check the filetype of the current buffer:

`:set filetype?`

------------------------------------------------------------------------

### Summary

-   Okivim configures formatters but does not manage toolchains.
-   Default formatters match the LSPs supported by this distribution.
-   Install the formatter you want.
-   If it is listed, it works automatically.
-   If not, add it to `formatters_by_ft`.
-   Use `:ConformInfo` to verify the active formatter.

:::info
Formatter configurations are defined in `lua/okivim/plugins/conform.lua`
:::
